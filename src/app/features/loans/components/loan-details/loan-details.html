<div #container class="loan-details-container">
  <div class="action-buttons">
    <button #btnBack type="button" class="btn-back" (click)="goBack()">
      โ ุจุงุฒฺฏุดุช ุจู ูุณุช ูุงูโูุง
    </button>
    <button
      #btnPrint
      type="button"
      class="btn-print"
      (click)="printLoanDetails()"
      *ngIf="loan"
    >
      ๐จ๏ธ ฺุงูพ ุงุทูุงุนุงุช ูุงู
    </button>
  </div>

  <div *ngIf="loading" class="loading">ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ุงุทูุงุนุงุช ูุงู...</div>
  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="loan && !loading" class="loan-info">
    <h2>ุฌุฒุฆุงุช ูุงู</h2>
    <div class="info-grid">
      <div class="info-item" #infoItem>
        <label>ูุจูุบ ูุงู:</label>
        <span #amountText>{{ loan.requestedAmount | number }} ุชููุงู</span>
      </div>

      <div class="info-item" #infoItem>
        <label>ุชุนุฏุงุฏ ุงูุณุงุท:</label>
        <span #installmentsText>{{ installments.length }} ูุณุท</span>
      </div>

      <div class="info-item" #infoItem>
        <label>ูุฏู ูุงู:</label>
        <span #purposeText>{{ loan.purpose }}</span>
      </div>

      <div class="info-item" #infoItem>
        <label>ุชุงุฑุฎ ุซุจุช:</label>
        <span #dateText>{{ formatDate(loan.submitDate) }}</span>
      </div>

      <div class="info-item" #infoItem>
        <label>ูุถุนุช:</label>
        <span
          #statusText
          class="status-badge"
          [ngClass]="getStatusClass(loan.status)"
        >
          {{ getStatusLabel(loan.status) }}
        </span>
      </div>

      <div class="info-item" #infoItem>
        <label>ุดูุงุณู ูุงู:</label>
        <span #idText>{{ loan.id }}</span>
      </div>

      <div class="info-item" #infoItem>
        <label>ุดูุงุณู ฺฉุงุฑุจุฑ:</label>
        <span #userIdText>{{ loan.userId }}</span>
      </div>
    </div>

    <!-- Installments Section -->
    <div class="installments-section">
      <button class="toggle-installments" (click)="toggleInstallments()">
        {{ showInstallments ? "โฒ ูพููุงู ฺฉุฑุฏู ุงูุณุงุท" : "โผ ููุงุด ุงูุณุงุท" }}
      </button>

      <div
        *ngIf="showInstallments && installments.length > 0"
        class="installments-list"
      >
        <h3>ูุณุช ุงูุณุงุท</h3>
        <div class="installment-header">
          <div>ุดูุงุฑู</div>
          <div>ุชุงุฑุฎ ุณุฑุฑุณุฏ</div>
          <div>ูุจูุบ</div>
          <div>ูุถุนุช</div>
          <div>ุฏฺฉูู ูพุฑุฏุงุฎุช</div>
        </div>
        <div
          *ngFor="let installment of installments; trackBy: trackByNumber"
          class="installment-item"
        >
          <div>{{ installment.number }}</div>
          <div>{{ formatDate(installment.dueDate.toString()) }}</div>
          <div>{{ formatCurrency(installment.totalAmount) }} ุชููุงู</div>
          <div [ngClass]="'status-' + installment.status.toLowerCase()">
            {{ getStatusLabel(installment.status) }}
          </div>
          <div>
            <button
              class="btn-pay"
              [disabled]="installment.status.toLowerCase() === 'paid'"
              (click)="payInstallment(installment)"
            >
              {{
                installment.status.toLowerCase() === "paid"
                  ? "ูพุฑุฏุงุฎุช ุดุฏู"
                  : "ูพุฑุฏุงุฎุช"
              }}
            </button>
          </div>
        </div>
      </div>

      <div
        *ngIf="showInstallments && installments.length === 0"
        class="no-installments"
      >
        ูฺ ูุณุท ุงูุช ูุดุฏ
      </div>
    </div>
  </div>

  <!-- Signature Modal -->
  <div class="signature-modal" *ngIf="showSignaturePad">
    <div class="modal-content">
      <h3>
        {{
          isCustomerSigning
            ? "ูุทูุง ุงูุถุง ูุดุชุฑ ุฑุง ุงูุฌุงู ุฏูุฏ"
            : "ูุทูุง ุงูุถุง ูุณุฆูู ุฑุง ุงูุฌุงู ุฏูุฏ"
        }}
      </h3>
      <canvas
        #signatureCanvas
        (mousedown)="startDrawing($event)"
        (touchstart)="startDrawing($event)"
        (mousemove)="draw($event)"
        (touchmove)="draw($event)"
        (mouseup)="stopDrawing()"
        (mouseleave)="stopDrawing()"
        (touchend)="stopDrawing()"
      ></canvas>
      <div class="signature-actions">
        <button (click)="clearSignature()">ูพุงฺฉ ฺฉุฑุฏู</button>
        <button (click)="saveSignature()">ุฐุฎุฑู ุงูุถุง</button>
        <button (click)="showSignaturePad = false">ุจุณุชู</button>
      </div>
    </div>
  </div>

  <!-- Print Container (Hidden) -->
  <div class="print-container" #printContainer>
    <h1>ฺฏุฒุงุฑุด ูุงู ุดูุงุฑู {{ loan?.id }}</h1>

    <div class="print-header">
      <div class="print-logo">
        <img src="/assets/images/logo.png" alt="Logo" />
      </div>
      <div class="print-meta">
        <div>ุชุงุฑุฎ ฺุงูพ: {{ currentDate | persianDate }}</div>
      </div>
    </div>

    <div class="print-section">
      <h2>ุงุทูุงุนุงุช ฺฉู ูุงู</h2>
      <table class="print-table">
        <tr>
          <th>ูุจูุบ ูุงู:</th>
          <td>{{ loan?.requestedAmount | number }} ุชููุงู</td>
        </tr>
        <tr>
          <th>ุชุนุฏุงุฏ ุงูุณุงุท:</th>
          <td>{{ installments.length }} ูุณุท</td>
        </tr>
        <tr>
          <th>ูุถุนุช:</th>
          <td [class]="'status-' + loan?.status?.toLowerCase()">
            {{ getStatusLabel(loan?.status || "") }}
          </td>
        </tr>
        <tr>
          <th>ุชุงุฑุฎ ุซุจุช:</th>
          <td>{{ formatDate(loan?.submitDate || "") }}</td>
        </tr>
      </table>
    </div>

    <div class="print-section" *ngIf="installments.length > 0">
      <h2>ุฌุฏูู ุงูุณุงุท</h2>
      <table class="print-table installments">
        <thead>
          <tr>
            <th>ุดูุงุฑู</th>
            <th>ุชุงุฑุฎ ุณุฑุฑุณุฏ</th>
            <th>ูุจูุบ (ุชููุงู)</th>
            <th>ูุถุนุช</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let installment of installments">
            <td>{{ installment.number }}</td>
            <td>{{ formatDate(installment.dueDate.toString()) }}</td>
            <td>{{ installment.totalAmount | number }}</td>
            <td [class]="'status-' + installment.status.toLowerCase()">
              {{ getStatusLabel(installment.status) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="print-footer">
      <div class="signature-area">
        <div>ุงูุถุงุก ูุดุชุฑ:</div>
        <img
          *ngIf="customerSignatureDataUrl"
          [src]="customerSignatureDataUrl"
          class="signature-image"
        />
        <div class="signature-line"></div>
      </div>
      <div class="signature-area">
        <div>ุงูุถุงุก ูุณุฆูู:</div>
        <img
          *ngIf="officerSignatureDataUrl"
          [src]="officerSignatureDataUrl"
          class="signature-image"
        />
        <div class="signature-line"></div>
      </div>
      <div class="print-notes">
        <p>ุชูุฌู: ุงู ฺฏุฒุงุฑุด ุตุฑูุง ุฌูุช ุงุทูุงุน ูโุจุงุดุฏ.</p>
      </div>
    </div>
  </div>
</div>
